# NOTE: API_BASE_URL and SERVER_NAME are dynamically substituted as part of Docker build process
server {
    listen 80;
    listen [::]:80;

    # SSL configuration
    #
    # listen 443 ssl;
    # listen [::]:443 ssl;
    #
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332
    #
    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782
    #
    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    #
    # include snippets/snakeoil.conf;

    root /var/www/html;

    index index.html;

    server_name $SERVER_NAME;

    # This rule adds support for client side routing
    # All URLs return the index.html
    location / {
        try_files $uri  $uri/ /index.html ;
        add_header Cache-Control "no-cache";
    }

    # This rule proxies backend API calls to another server
    # At startup, we replace $API_BASE_URL with the value specified as environment variable
    location /api {
        proxy_pass $API_BASE_URL;
    }

    # This sets cache headers for any file that has a hash in the file name
    location ~* "(.+)(\.[a-fA-F0-9]{8,32}\.)(.+)$" {
        add_header Cache-Control "max-age=31536000";
    }

    # This rule is nice to have, delete it if it breaks something
    # 
    # Motivation: if a file is not found, we return index.html by default, so that client side routing works
    # But if the file has one of these extensions, we should instead return a 404
    location ~* \.(css|xml|gif|jpeg|jpg|js|txt|png|svg|svgz|tif|tiff|wbmp|webp|ico|jng|bmp|woff|woff2|json|doc|pdf|rtf|kml|kmz|rar|rpm|zip|mid|midi|kar|mp3|ogg|m4a|ra|3gpp|3gp|ts|mp4|mpeg|mpg|mov|webm|flv|m4v|mng|asx|asf|wmv|avi) {
        try_files $uri =404;
    }
}